---
name: changelog

on:
  workflow_dispatch:
  push:
    tags:
      - v*

env:
  BRANCH: main
  COMMITTER_BOT: GitHub <noreply@github.com>
  AUTHOR_BOT: actions-bot <actions-bot@users.noreply.github.com>

jobs:
  update-changelog:
    runs-on: ubuntu-latest
    name: changelog-generator
    # if: "!contains(github.event.head_commit.message, 'skip')"
    steps:
    # To use this repository's private action, you must check out the repository
    - name: "üì• Check-out"
      uses: actions/checkout@v2
      with:
        fetch-depth: 5

    - name: "‚úèÔ∏è Generate full changelog"
      id: ch
      uses: heinrichreimer/github-changelog-generator-action@v2.2
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        output: CHANGELOG.md
        issuesWoLabels: true
        pullRequests: true
        prWoLabels: true
        author: true
        unreleased: true
        futureRelease: true

    - name: read 'templates/changelog'
      id: ch-template
      uses: juliangruber/read-file-action@v1
      with:
        path: .github/templates/changelog

    - name: write to changelog.md
      uses: DamianReeves/write-file-action@master
      with:
        path: CHANGELOG.md
        contents: ${{ steps.ch-template.outputs.content }}
        write-mode: append

    - name: 'üñ®Ô∏è Print changelog to console'
      run: |
        cat CHANGELOG.md

    - name: check local changes
      id: diff
      run: |
        changed_files=$(git status --porcelain --untracked-files=all | wc -l)
        echo ::set-output name=count::$changed_files
        echo ::set-output name=created::$(date)
        echo ::set-output name=created::$(date)
      shell: bash

    #  apply tag
    - uses: stefanzweifel/git-auto-commit-action@v4
      with:
        file_pattern: CHANGELOG.md
        commit_message: |
          'docs: Update CHANGELOG.md "${{ github.workflow }} #${{ github.run_number }}" [skip ci]'



    # - name: check outputs
    #   if: ${{ steps.ch.outputs.skipped == 'false' }}
    #   run: |
    #     echo "Pull Request Number - ${{ steps.cpr.outputs.pull-request-number }}"
    #     echo "Pull Request URL - ${{ steps.cpr.outputs.pull-request-url }}"
